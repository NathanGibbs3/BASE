---
language: php

# branch blocklist
branches:
  except:
    - documentation
    - gh-ops

# setup services
services:
  - mysql
  - postgresql

# Default matrix overlay.
matrix:
  include:
    - php: 5.2
      dist: precise
      env: DB=mysql Composer=0 XDebug=1 Coveralls=0
    - php: 5.2
      dist: precise
      env: DB=postgres Composer=0 XDebug=1 Coveralls=0
    - php: 5.3
      dist: precise
      env: DB=mysql Composer=1 XDebug=0 Coveralls=1
    - php: 5.3
      dist: precise
      env: DB=postgres Composer=1 XDebug=0 Coveralls=1
    - php: 5.4
      env: DB=mysql Composer=1 XDebug=0 Coveralls=1
    - php: 5.4
      env: DB=postgres Composer=1 XDebug=0 Coveralls=1
    - php: 5.5
      env: DB=mysql Composer=1 XDebug=0 Coveralls=2
    - php: 5.5
      env: DB=postgres Composer=1 XDebug=0 Coveralls=2
    - php: 5.6
      env: DB=mysql Composer=1 XDebug=0 Coveralls=2
    - php: 5.6
      env: DB=postgres Composer=1 XDebug=0 Coveralls=2
    - php: 7.0
      if: branch != php5only
      env: DB=mysql Composer=1 XDebug=0 Coveralls=2
    - php: 7.0
      if: branch != php5only
      env: DB=postgres Composer=1 XDebug=0 Coveralls=2
    - php: 7.1
      if: branch != php5only
      env: DB=mysql Composer=1 XDebug=0 Coveralls=2
    - php: 7.1
      if: branch != php5only
      env: DB=postgres Composer=1 XDebug=0 Coveralls=2
    - php: 7.2
      if: branch != php5only
      env: DB=mysql Composer=1 XDebug=0 Coveralls=2
    - php: 7.2
      if: branch != php5only
      env: DB=postgres Composer=1 XDebug=0 Coveralls=2
    - php: 7.3
      if: branch != php5only
      env: DB=mysql Composer=1 XDebug=0 Coveralls=2
    - php: 7.3
      if: branch != php5only
      env: DB=postgres Composer=1 XDebug=0 Coveralls=2
    - php: nightly
      if: branch != php5only
      env: DB=mysql Composer=0 XDebug=0 Coveralls=2
    - php: nightly
      if: branch != php5only
      env: DB=postgres Composer=0 XDebug=0 Coveralls=2

cache:
  directories:
    - $HOME/.composer/cache

before_install:
  - sudo apt-get update > /dev/null

install:
  # XDebug for PHP 5.2x
  # - sh -c "if [ '$XDebug' = 1 ]; then pecl install xdebug-2.2.7; fi"
  # Composer Support PHP 5.3.2+
  - sh -c "if [ '$Composer' = 1 ]; then curl -s http://getcomposer.org/installer | php; fi"
  - sh -c "if [ '$Composer' = 1 ]; then php composer.phar install --dev --no-interaction; fi"

before_script:

script:
  - mkdir -p build/logs
  - sh -c "if [ '$DB' = 'postgres' ]; then psql -c 'DROP DATABASE IF EXISTS snort;' -U postgres; fi"
  - sh -c "if [ '$DB' = 'postgres' ]; then psql -c 'CREATE DATABASE snort;' -U postgres; fi"
  - sh -c "if [ '$DB' = 'mysql' ]; then mysql -e 'CREATE DATABASE IF NOT EXISTS snort;'; fi"
  - sh -c "if [ '$DB' = 'postgres' ]; then psql -d snort -f sql/create_base_tbls_pgsql.sql; fi"
  - sh -c "if [ '$DB' = 'mysql' ]; then mysql snort < sql/create_base_tbls_mysql.sql; fi"
  - sh -c "if [ '$DB' = 'postgres' ]; then psql -d snort -f sql/create_base_tbls_pgsql_extra.sql; fi"
  - php -f index.php
  - phpunit -c phpunit.xml.dist

after_success:
  # Coveralls 1.x Support PHP 5.3+
  - sh -c "if [ '$Composer' = 1 &&  '$Coveralls' = 1 ]; then php vendor/bin/coveralls -v; fi"
  # Coveralls 2.x Support PHP 5.5+
  - sh -c "if [ '$Composer' = 1 &&  '$Coveralls' = 2 ]; then php vendor/bin/php-coveralls -v; fi"
...
